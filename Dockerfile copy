FROM alpine:3.22.0

# Create a non-root user with no password and no shell
RUN addgroup -S backup && adduser -S -G backup -h /home/backup -s /bin/bash backup

# Install only the needed packages
RUN apk add --no-cache \
    bash \
    curl \
    unzip \
    postgresql15-client \
    cronie \
    aws-cli \
    su-exec \
 && rm -rf /var/cache/apk/*

# Set environment early to avoid leaks
ENV CRON_SCHEDULE_BACKUP="0 1 * * *" \
    CRON_SCHEDULE_CLEAN="0 2 * * *"

# Create directories with restricted access
RUN mkdir -p /usr/local/bin /var/log/backup /home/backup  \
 && chown -R backup:backup /usr/local/bin /var/log/backup /home/backup  \
 && chmod -R 700 /usr/local/bin /var/log/backup /home/backup

# Copy scripts
COPY --chown=backup:backup env.sh /usr/local/bin/env.sh
COPY --chown=backup:backup autobackup.sh /usr/local/bin/autobackup.sh
COPY --chown=backup:backup clean_old_backup.sh /usr/local/bin/clean_old_backup.sh
COPY --chown=backup:backup entrypoint.sh /usr/local/bin/entrypoint.sh

# Restrict script execution permissions
RUN chmod 500 /usr/local/bin/*.sh

# Switch to non-root user
USER backup

WORKDIR /home/backup

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
